<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<title>Đăng nhập</title>
</head>
<body>
	<div layout:fragment="content"
		class="d-flex justify-content-center align-items-center"
		style="min-height: 70vh;">
		<div class="card shadow-sm p-4" style="width: 400px;">
			<h2 class="text-center mb-4">Đăng nhập</h2>
			<form id="loginForm" method="post">
				<label>Email:</label> <input type="text" id="email" name="email"
					required /> <label>Mật khẩu:</label> <input type="password"
					id="passwd" name="passwd" required />

				<button type="submit">Đăng nhập</button>
			</form>
			<div id="errorBox" style="color: red; display: none;">Sai email
				hoặc mật khẩu!</div>


			<p class="mt-3 text-center">
				Chưa có tài khoản? <a th:href="@{/register}">Đăng ký</a>
			</p>
		</div>
	</div>

	<script>
	document.getElementById("loginForm").addEventListener("submit", async function(e) {
	    e.preventDefault(); // 🔑 chặn GET mặc định

	    const email = document.getElementById("email").value;
	    const passwd = document.getElementById("passwd").value;

	    try {
	        const res = await fetch("/auth/login", {
	            method: "POST",
	            headers: { "Content-Type": "application/x-www-form-urlencoded" },
	            body: new URLSearchParams({ email, passwd })
	        });

	        if (!res.ok) {
	            document.getElementById("errorBox").style.display = "block";
	            return;
	        }

	        const token = await res.text();   // server trả JWT
	        localStorage.setItem("jwt", token); // lưu token
	        window.location.href = "/home";   // chuyển hướng sau khi login
	    } catch (err) {
	        console.error(err);
	        document.getElementById("errorBox").style.display = "block";
	    }
	});

</script>
</body>
</html>
